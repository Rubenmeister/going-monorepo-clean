(()=>{"use strict";const t=require("tslib"),e=require("@nestjs/core"),i=require("@nestjs/common"),r=require("@nestjs/config"),o=require("@prisma/client");var a;let s=a=class PrismaService extends o.PrismaClient{constructor(){super({log:"development"===process.env.NODE_ENV?["query","info","warn","error"]:["error"]}),this.logger=new i.Logger(a.name)}onModuleInit(){return(0,t.__awaiter)(this,void 0,void 0,function*(){try{yield this.$connect(),this.logger.log("Connected to PostgreSQL database")}catch(t){throw this.logger.error("Failed to connect to PostgreSQL database",t),t}})}onModuleDestroy(){return(0,t.__awaiter)(this,void 0,void 0,function*(){yield this.$disconnect(),this.logger.log("Disconnected from PostgreSQL database")})}executeTransaction(e){return(0,t.__awaiter)(this,void 0,void 0,function*(){return this.$transaction(e)})}cleanDatabase(){return(0,t.__awaiter)(this,void 0,void 0,function*(){if("test"!==process.env.NODE_ENV)throw new Error("cleanDatabase can only be used in test environment");const t=yield this.$queryRaw`
      SELECT tablename FROM pg_tables WHERE schemaname='public'
    `;for(const{tablename:e}of t)"_prisma_migrations"!==e&&(yield this.$executeRawUnsafe(`TRUNCATE TABLE "public"."${e}" CASCADE;`))})}};s=a=(0,t.__decorate)([(0,i.Injectable)(),(0,t.__metadata)("design:paramtypes",[])],s);let n=class PrismaModule{};n=(0,t.__decorate)([(0,i.Global)(),(0,i.Module)({providers:[s],exports:[s]})],n);class Tour{constructor(t){this.id=t.id,this.hostId=t.hostId,this.title=t.title,this.description=t.description,this.pricePerPerson=t.pricePerPerson,this.currency=t.currency,this.maxCapacity=t.maxCapacity,this.durationHours=t.durationHours,this.location=t.location,this.meetingPoint=t.meetingPoint,this.status=t.status,this.createdAt=t.createdAt,this.updatedAt=t.updatedAt}static create(t){return new Tour(Object.assign(Object.assign({id:crypto.randomUUID()},t),{status:"DRAFT",createdAt:new Date,updatedAt:new Date}))}static fromPrimitives(t){return new Tour(t)}toPrimitives(){return{id:this.id,hostId:this.hostId,title:this.title,description:this.description,pricePerPerson:this.pricePerPerson,currency:this.currency,maxCapacity:this.maxCapacity,durationHours:this.durationHours,location:this.location,meetingPoint:this.meetingPoint,status:this.status,createdAt:this.createdAt,updatedAt:this.updatedAt}}publish(){if("PUBLISHED"===this.status)throw new Error("Tour is already published.");this.status="PUBLISHED",this.updatedAt=new Date}archive(){this.status="ARCHIVED",this.updatedAt=new Date}update(t){t.title&&(this.title=t.title),t.description&&(this.description=t.description),t.pricePerPerson&&(this.pricePerPerson=t.pricePerPerson),t.currency&&(this.currency=t.currency),t.maxCapacity&&(this.maxCapacity=t.maxCapacity),t.durationHours&&(this.durationHours=t.durationHours),t.location&&(this.location=t.location),t.meetingPoint&&(this.meetingPoint=t.meetingPoint),this.updatedAt=new Date}}const c=Symbol("ITourRepository");var d;let u=class PrismaTourRepository{constructor(t){this.prisma=t}save(e){return(0,t.__awaiter)(this,void 0,void 0,function*(){const t=e.toPrimitives();yield this.prisma.tour.upsert({where:{id:t.id},create:{id:t.id,hostId:t.hostId,title:t.title,description:t.description,pricePerPerson:t.pricePerPerson,currency:t.currency,maxCapacity:t.maxCapacity,durationHours:t.durationHours,location:t.location,meetingPoint:t.meetingPoint,status:this.toPrismaStatus(t.status)},update:{title:t.title,description:t.description,pricePerPerson:t.pricePerPerson,currency:t.currency,maxCapacity:t.maxCapacity,durationHours:t.durationHours,location:t.location,meetingPoint:t.meetingPoint,status:this.toPrismaStatus(t.status)}})})}findById(e){return(0,t.__awaiter)(this,void 0,void 0,function*(){const t=yield this.prisma.tour.findUnique({where:{id:e}});return t?this.toDomain(t):null})}findByHostId(e){return(0,t.__awaiter)(this,void 0,void 0,function*(){return(yield this.prisma.tour.findMany({where:{hostId:e}})).map(t=>this.toDomain(t))})}search(e){return(0,t.__awaiter)(this,void 0,void 0,function*(){return(yield this.prisma.tour.findMany({where:Object.assign(Object.assign(Object.assign({status:"PUBLISHED"},e.location&&{location:{contains:e.location}}),e.minPrice&&{pricePerPerson:{gte:e.minPrice}}),e.maxPrice&&{pricePerPerson:{lte:e.maxPrice}})})).map(t=>this.toDomain(t))})}update(e){return(0,t.__awaiter)(this,void 0,void 0,function*(){yield this.save(e)})}toPrismaStatus(t){return t}toDomain(t){return Tour.fromPrimitives({id:t.id,hostId:t.hostId,title:t.title,description:t.description,pricePerPerson:Number(t.pricePerPerson),currency:t.currency,maxCapacity:t.maxCapacity,durationHours:Number(t.durationHours),location:t.location,meetingPoint:t.meetingPoint,status:t.status,createdAt:t.createdAt,updatedAt:t.updatedAt})}};u=(0,t.__decorate)([(0,i.Injectable)(),(0,t.__metadata)("design:paramtypes",["function"==typeof(d=void 0!==s&&s)?d:Object])],u);let p=class InfrastructureModule{};var l;p=(0,t.__decorate)([(0,i.Global)(),(0,i.Module)({imports:[r.ConfigModule.forRoot({isGlobal:!0}),n],providers:[{provide:c,useClass:u},u],exports:[c,u]})],p);let m=class CreateTourUseCase{constructor(t){this.tourRepo=t}execute(e){return(0,t.__awaiter)(this,void 0,void 0,function*(){const t=Tour.create({hostId:e.hostId,title:e.title,description:e.description,pricePerPerson:e.pricePerPerson,currency:e.currency,maxCapacity:e.maxCapacity,durationHours:e.durationHours,location:e.location,meetingPoint:e.meetingPoint});return yield this.tourRepo.save(t),{id:t.id}})}};m=(0,t.__decorate)([(0,i.Injectable)(),(0,t.__param)(0,(0,i.Inject)(c)),(0,t.__metadata)("design:paramtypes",["function"==typeof(l=void 0!==c&&c)?l:Object])],m);let h=class TourApplicationModule{};h=(0,t.__decorate)([(0,i.Module)({providers:[m],exports:[m]})],h);const _=require("class-validator");class CreateTourDto{}var y,P;(0,t.__decorate)([(0,_.IsNotEmpty)(),(0,_.IsString)(),(0,t.__metadata)("design:type",String)],CreateTourDto.prototype,"hostId",void 0),(0,t.__decorate)([(0,_.IsNotEmpty)(),(0,_.IsString)(),(0,t.__metadata)("design:type",String)],CreateTourDto.prototype,"title",void 0),(0,t.__decorate)([(0,_.IsNotEmpty)(),(0,_.IsString)(),(0,t.__metadata)("design:type",String)],CreateTourDto.prototype,"description",void 0),(0,t.__decorate)([(0,_.IsNotEmpty)(),(0,_.IsNumber)(),(0,_.Min)(0),(0,t.__metadata)("design:type",Number)],CreateTourDto.prototype,"pricePerPerson",void 0),(0,t.__decorate)([(0,_.IsNotEmpty)(),(0,_.IsIn)(["USD","EUR"]),(0,t.__metadata)("design:type",String)],CreateTourDto.prototype,"currency",void 0),(0,t.__decorate)([(0,_.IsNotEmpty)(),(0,_.IsNumber)(),(0,_.Min)(1),(0,t.__metadata)("design:type",Number)],CreateTourDto.prototype,"maxCapacity",void 0),(0,t.__decorate)([(0,_.IsNotEmpty)(),(0,_.IsNumber)(),(0,_.Min)(1),(0,t.__metadata)("design:type",Number)],CreateTourDto.prototype,"durationHours",void 0),(0,t.__decorate)([(0,_.IsNotEmpty)(),(0,_.IsString)(),(0,t.__metadata)("design:type",String)],CreateTourDto.prototype,"location",void 0),(0,t.__decorate)([(0,_.IsNotEmpty)(),(0,_.IsString)(),(0,t.__metadata)("design:type",String)],CreateTourDto.prototype,"meetingPoint",void 0);let g=class ToursController{constructor(t){this.createTourUseCase=t}createTour(e){return(0,t.__awaiter)(this,void 0,void 0,function*(){return this.createTourUseCase.execute(e)})}};(0,t.__decorate)([(0,i.Post)(),(0,t.__param)(0,(0,i.Body)()),(0,t.__metadata)("design:type",Function),(0,t.__metadata)("design:paramtypes",["function"==typeof(P=void 0!==CreateTourDto&&CreateTourDto)?P:Object]),(0,t.__metadata)("design:returntype",Promise)],g.prototype,"createTour",null),g=(0,t.__decorate)([(0,i.Controller)("tours"),(0,t.__metadata)("design:paramtypes",["function"==typeof(y=void 0!==m&&m)?y:Object])],g);let v=class AppModule{};v=(0,t.__decorate)([(0,i.Module)({imports:[r.ConfigModule.forRoot({isGlobal:!0}),p,h],controllers:[g],providers:[]})],v),function(){(0,t.__awaiter)(this,void 0,void 0,function*(){const t=yield e.NestFactory.create(v),r=process.env.PORT||3009;t.enableCors(),t.setGlobalPrefix("api"),t.useGlobalPipes(new i.ValidationPipe({whitelist:!0,transform:!0})),yield t.listen(r),i.Logger.log(`\ud83d\ude80 Tours-Service est\xe1 corriendo en http://localhost:${r}/api`,"Bootstrap")})}()})();
//# sourceMappingURL=main.js.map