(()=>{"use strict";const e=require("tslib"),t=(require("reflect-metadata"),require("@nestjs/common")),r=require("@nestjs/core"),s=require("@nestjs/config"),i=require("@nestjs/jwt"),o=require("@prisma/client");var a;let n=a=class PrismaService extends o.PrismaClient{constructor(){super({log:"development"===process.env.NODE_ENV?["query","info","warn","error"]:["error"]}),this.logger=new t.Logger(a.name)}onModuleInit(){return(0,e.__awaiter)(this,void 0,void 0,function*(){try{yield this.$connect(),this.logger.log("Connected to PostgreSQL database")}catch(e){throw this.logger.error("Failed to connect to PostgreSQL database",e),e}})}onModuleDestroy(){return(0,e.__awaiter)(this,void 0,void 0,function*(){yield this.$disconnect(),this.logger.log("Disconnected from PostgreSQL database")})}executeTransaction(t){return(0,e.__awaiter)(this,void 0,void 0,function*(){return this.$transaction(t)})}cleanDatabase(){return(0,e.__awaiter)(this,void 0,void 0,function*(){if("test"!==process.env.NODE_ENV)throw new Error("cleanDatabase can only be used in test environment");const e=yield this.$queryRaw`
      SELECT tablename FROM pg_tables WHERE schemaname='public'
    `;for(const{tablename:t}of e)"_prisma_migrations"!==t&&(yield this.$executeRawUnsafe(`TRUNCATE TABLE "public"."${t}" CASCADE;`))})}};n=a=(0,e.__decorate)([(0,t.Injectable)(),(0,e.__metadata)("design:paramtypes",[])],n);let d=class PrismaModule{};d=(0,e.__decorate)([(0,t.Global)(),(0,t.Module)({providers:[n],exports:[n]})],d);const c=require("uuid"),l=require("neverthrow");class Role{constructor(e){this.value=e}static create(e){return Object.values(u).includes(e)?(0,l.ok)(new Role(e)):(0,l.err)(new Error(`Invalid role: ${e}`))}static fromPrimitives(e){return new Role(e)}toPrimitives(){return this.value}}var u;!function(e){e.USER="USER",e.ADMIN="ADMIN",e.DRIVER="DRIVER",e.HOST="HOST"}(u||(u={}));class User{constructor(e){this.id=e.id,this.email=e.email,this.passwordHash=e.passwordHash,this.firstName=e.firstName,this.lastName=e.lastName,this.phone=e.phone,this.roles=e.roles,this.status=e.status,this.createdAt=e.createdAt,this.verificationToken=e.verificationToken}static create(e){if(e.firstName.length<2)return(0,l.err)(new Error("First name is too short"));const t=new User(Object.assign(Object.assign({id:(0,c.v4)()},e),{status:"pending_verification",createdAt:new Date,verificationToken:(0,c.v4)()}));return(0,l.ok)(t)}toPrimitives(){return{id:this.id,email:this.email,passwordHash:this.passwordHash,firstName:this.firstName,lastName:this.lastName,phone:this.phone,roles:this.roles.map(e=>e.value),status:this.status,createdAt:this.createdAt,verificationToken:this.verificationToken}}static fromPrimitives(e){return new User(Object.assign(Object.assign({},e),{roles:e.roles.map(e=>Role.create(e)._unsafeUnwrap?Role.create(e)._unsafeUnwrap():Role.create(e))}))}verifyAccount(){return"active"===this.status?(0,l.err)(new Error("Account is already active")):(this.status="active",this.verificationToken=void 0,(0,l.ok)(void 0))}checkPassword(e,t){return t.compare(e,this.passwordHash)}hasRole(e){return this.roles.some(t=>t.value===e)}}const p=require("class-validator");class RegisterUserDto{}(0,e.__decorate)([(0,p.IsNotEmpty)(),(0,p.IsEmail)(),(0,e.__metadata)("design:type",String)],RegisterUserDto.prototype,"email",void 0),(0,e.__decorate)([(0,p.IsNotEmpty)(),(0,p.IsString)(),(0,p.MinLength)(8,{message:"Password must be at least 8 characters"}),(0,e.__metadata)("design:type",String)],RegisterUserDto.prototype,"password",void 0),(0,e.__decorate)([(0,p.IsNotEmpty)(),(0,p.IsString)(),(0,e.__metadata)("design:type",String)],RegisterUserDto.prototype,"firstName",void 0),(0,e.__decorate)([(0,p.IsNotEmpty)(),(0,p.IsString)(),(0,e.__metadata)("design:type",String)],RegisterUserDto.prototype,"lastName",void 0),(0,e.__decorate)([(0,p.IsString)(),(0,p.IsOptional)(),(0,e.__metadata)("design:type",String)],RegisterUserDto.prototype,"phone",void 0),(0,e.__decorate)([(0,p.IsNotEmpty)(),(0,p.IsEnum)(u,{each:!0}),(0,e.__metadata)("design:type",Array)],RegisterUserDto.prototype,"roles",void 0);const _=Symbol("IUserRepository"),m=Symbol("IPasswordHasher"),h=Symbol("ITokenService");var g;let v=class PrismaUserRepository{constructor(e){this.prisma=e}save(t){return(0,e.__awaiter)(this,void 0,void 0,function*(){var e;try{const r=t.toPrimitives();return yield this.prisma.user.create({data:{id:r.id,email:r.email,passwordHash:r.passwordHash,name:r.name,role:r.role,isActive:null===(e=r.isActive)||void 0===e||e}}),(0,l.ok)(void 0)}catch(r){return(0,l.err)(new Error(`Failed to save user: ${r.message}`))}})}update(t){return(0,e.__awaiter)(this,void 0,void 0,function*(){try{const e=t.toPrimitives();return yield this.prisma.user.update({where:{id:e.id},data:{email:e.email,passwordHash:e.passwordHash,name:e.name,role:e.role,isActive:e.isActive,updatedAt:new Date}}),(0,l.ok)(void 0)}catch(e){return(0,l.err)(new Error(`Failed to update user: ${e.message}`))}})}findById(t){return(0,e.__awaiter)(this,void 0,void 0,function*(){try{const e=yield this.prisma.user.findUnique({where:{id:t}});return e?(0,l.ok)(this.toDomain(e)):(0,l.ok)(null)}catch(e){return(0,l.err)(new Error(`Failed to find user by id: ${e.message}`))}})}findByEmail(t){return(0,e.__awaiter)(this,void 0,void 0,function*(){try{const e=yield this.prisma.user.findUnique({where:{email:t}});return e?(0,l.ok)(this.toDomain(e)):(0,l.ok)(null)}catch(e){return(0,l.err)(new Error(`Failed to find user by email: ${e.message}`))}})}findByVerificationToken(t){return(0,e.__awaiter)(this,void 0,void 0,function*(){try{return(0,l.ok)(null)}catch(e){return(0,l.err)(new Error(`Failed to find user by verification token: ${e.message}`))}})}toDomain(e){return User.fromPrimitives({id:e.id,email:e.email,passwordHash:e.passwordHash,name:e.name,role:e.role,isActive:e.isActive,createdAt:e.createdAt,updatedAt:e.updatedAt})}};v=(0,e.__decorate)([(0,t.Injectable)(),(0,e.__metadata)("design:paramtypes",["function"==typeof(g=void 0!==n&&n)?g:Object])],v);const y=require("bcrypt");let f=class BcryptHasher{constructor(){this.SALT_ROUNDS=10}hash(e){return y.hash(e,this.SALT_ROUNDS)}compare(e,t){return y.compare(e,t)}};var w;f=(0,e.__decorate)([(0,t.Injectable)()],f);let E=class JwtTokenService{constructor(e){this.jwtService=e}sign(e){return this.jwtService.sign(e)}verify(e){return this.jwtService.verify(e)}};E=(0,e.__decorate)([(0,t.Injectable)(),(0,e.__metadata)("design:paramtypes",["function"==typeof(w=void 0!==i.JwtService&&i.JwtService)?w:Object])],E);let U=class InfrastructureModule{};U=(0,e.__decorate)([(0,t.Global)(),(0,t.Module)({imports:[d,i.JwtModule.registerAsync({imports:[s.ConfigModule],inject:[s.ConfigService],useFactory:e=>({secret:e.get("JWT_SECRET")||"default-secret-change-in-production",signOptions:{expiresIn:e.get("JWT_EXPIRATION")||"1h"}})})],providers:[{provide:_,useClass:v},{provide:m,useClass:f},{provide:h,useClass:E}],exports:[_,m,h,i.JwtModule]})],U);class register_user_dto_RegisterUserDto{}(0,e.__decorate)([(0,p.IsNotEmpty)(),(0,p.IsEmail)(),(0,e.__metadata)("design:type",String)],register_user_dto_RegisterUserDto.prototype,"email",void 0),(0,e.__decorate)([(0,p.IsNotEmpty)(),(0,p.IsString)(),(0,p.MinLength)(8,{message:"Password must be at least 8 characters"}),(0,e.__metadata)("design:type",String)],register_user_dto_RegisterUserDto.prototype,"password",void 0),(0,e.__decorate)([(0,p.IsNotEmpty)(),(0,p.IsString)(),(0,e.__metadata)("design:type",String)],register_user_dto_RegisterUserDto.prototype,"firstName",void 0),(0,e.__decorate)([(0,p.IsNotEmpty)(),(0,p.IsString)(),(0,e.__metadata)("design:type",String)],register_user_dto_RegisterUserDto.prototype,"lastName",void 0),(0,e.__decorate)([(0,p.IsString)(),(0,p.IsOptional)(),(0,e.__metadata)("design:type",String)],register_user_dto_RegisterUserDto.prototype,"phone",void 0),(0,e.__decorate)([(0,p.IsNotEmpty)(),(0,p.IsEnum)(u,{each:!0}),(0,e.__metadata)("design:type",Array)],register_user_dto_RegisterUserDto.prototype,"roles",void 0);class LoginUserDto{}(0,e.__decorate)([(0,p.IsNotEmpty)(),(0,p.IsEmail)(),(0,e.__metadata)("design:type",String)],LoginUserDto.prototype,"email",void 0),(0,e.__decorate)([(0,p.IsNotEmpty)(),(0,p.IsString)(),(0,e.__metadata)("design:type",String)],LoginUserDto.prototype,"password",void 0);var R,S;let I=class RegisterUserUseCase{constructor(e,t){this.userRepository=e,this.passwordHasher=t}execute(t){return(0,e.__awaiter)(this,void 0,void 0,function*(){if(yield this.userRepository.findByEmail(t.email))return(0,l.err)(new Error("User already exists"));const e=yield this.passwordHasher.hash(t.password),r=Role.create(u.USER);if(r.isErr())return(0,l.err)(r.error);const s=User.create({email:t.email,passwordHash:e,firstName:t.firstName,lastName:t.lastName,phone:t.phone,roles:[r.value]});if(s.isErr())return(0,l.err)(s.error);const i=s.value,o=yield this.userRepository.save(i);return o.isErr()?(0,l.err)(o.error):(0,l.ok)(i)})}};I=(0,e.__decorate)([(0,t.Injectable)(),(0,e.__param)(0,(0,t.Inject)(_)),(0,e.__param)(1,(0,t.Inject)(m)),(0,e.__metadata)("design:paramtypes",["function"==typeof(R=void 0!==_&&_)?R:Object,"function"==typeof(S=void 0!==m&&m)?S:Object])],I);class LoginUserUseCase{constructor(e,t,r){this.userRepository=e,this.passwordHasher=t,this.tokenService=r}execute(t){return(0,e.__awaiter)(this,void 0,void 0,function*(){const e=yield this.userRepository.findByEmail(t.email);if(e.isErr())return(0,l.err)(new Error("Invalid credentials"));const r=e.value;if(!(yield this.passwordHasher.compare(t.password,r.passwordHash)))return(0,l.err)(new Error("Invalid credentials"));const s={sub:r.id,email:r.email,role:"string"==typeof r.roles[0]?r.roles[0]:r.roles[0].value},i=this.tokenService.sign(s);return(0,l.ok)({user:r,token:i})})}}var b,D,N,A;let H=class AuthController{constructor(e,t){this.registerUserUseCase=e,this.loginUserUseCase=t}register(r){return(0,e.__awaiter)(this,void 0,void 0,function*(){const e=yield this.registerUserUseCase.execute(r);if(e.isErr())throw new t.HttpException(e.error.message,t.HttpStatus.BAD_REQUEST);return e.value})}login(r){return(0,e.__awaiter)(this,void 0,void 0,function*(){const e=yield this.loginUserUseCase.execute(r);if(e.isErr())throw new t.HttpException(e.error.message,t.HttpStatus.UNAUTHORIZED);return e.value})}};(0,e.__decorate)([(0,t.Post)("register"),(0,t.HttpCode)(t.HttpStatus.CREATED),(0,e.__param)(0,(0,t.Body)()),(0,e.__metadata)("design:type",Function),(0,e.__metadata)("design:paramtypes",["function"==typeof(N=void 0!==register_user_dto_RegisterUserDto&&register_user_dto_RegisterUserDto)?N:Object]),(0,e.__metadata)("design:returntype",Promise)],H.prototype,"register",null),(0,e.__decorate)([(0,t.Post)("login"),(0,t.HttpCode)(t.HttpStatus.OK),(0,e.__param)(0,(0,t.Body)()),(0,e.__metadata)("design:type",Function),(0,e.__metadata)("design:paramtypes",["function"==typeof(A=void 0!==LoginUserDto&&LoginUserDto)?A:Object]),(0,e.__metadata)("design:returntype",Promise)],H.prototype,"login",null),H=(0,e.__decorate)([(0,t.Controller)("auth"),(0,e.__metadata)("design:paramtypes",["function"==typeof(b=void 0!==I&&I)?b:Object,"function"==typeof(D=void 0!==LoginUserUseCase&&LoginUserUseCase)?D:Object])],H);let j=class AppModule{};j=(0,e.__decorate)([(0,t.Module)({imports:[s.ConfigModule.forRoot({isGlobal:!0,envFilePath:".env"}),U],controllers:[H],providers:[I,LoginUserUseCase]})],j),function(){(0,e.__awaiter)(this,void 0,void 0,function*(){const e=new t.Logger("Bootstrap");try{const s=yield r.NestFactory.create(j);s.enableCors(),s.setGlobalPrefix("api"),s.useGlobalPipes(new t.ValidationPipe({whitelist:!0,transform:!0}));const i=process.env.PORT||3333;yield s.listen(i),e.log(`\ud83d\ude80 BACKEND LISTO en: http://localhost:${i}/api`)}catch(s){e.error("\u274c ERROR FATAL:",s),process.exit(1)}})}()})();
//# sourceMappingURL=main.js.map