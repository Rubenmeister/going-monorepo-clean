{"version":3,"file":"main.js","mappings":"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","sources":["webpack/bootstrap","webpack/runtime/compat get default export","webpack/runtime/define property getters","webpack/runtime/hasOwnProperty shorthand","external commonjs \"tslib\"","external commonjs \"@nestjs/core\"","external commonjs \"@nestjs/common\"","external commonjs \"@nestjs/config\"","external commonjs \"@prisma/client\"","C:\\Users\\USER1\\going-monorepo-clean\\libs\\shared\\prisma-client\\src\\lib\\prisma.service.ts","C:\\Users\\USER1\\going-monorepo-clean\\libs\\shared\\prisma-client\\src\\lib\\prisma.module.ts","C:\\Users\\USER1\\going-monorepo-clean\\payment-service\\src\\infrastructure\\repositories\\prisma-payment.repository.ts","external commonjs \"stripe\"","C:\\Users\\USER1\\going-monorepo-clean\\payment-service\\src\\infrastructure\\gateways\\stripe.gateway.ts","C:\\Users\\USER1\\going-monorepo-clean\\payment-service\\src\\infrastructure\\infrastructure.module.ts","C:\\Users\\USER1\\going-monorepo-clean\\payment-service\\src\\api\\payment.controller.ts","C:\\Users\\USER1\\going-monorepo-clean\\payment-service\\src\\api\\webhook.controller.ts","C:\\Users\\USER1\\going-monorepo-clean\\payment-service\\src\\app.module.ts","C:\\Users\\USER1\\going-monorepo-clean\\payment-service\\src\\main.ts"],"sourcesContent":["// The require scope\nvar __webpack_require__ = {};\n\n","// getDefaultExport function for compatibility with non-harmony modules\n__webpack_require__.n = (module) => {\n\tvar getter = module && module.__esModule ?\n\t\t() => (module['default']) :\n\t\t() => (module);\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","const __WEBPACK_NAMESPACE_OBJECT__ = require(\"tslib\");","const __WEBPACK_NAMESPACE_OBJECT__ = require(\"@nestjs/core\");","const __WEBPACK_NAMESPACE_OBJECT__ = require(\"@nestjs/common\");","const __WEBPACK_NAMESPACE_OBJECT__ = require(\"@nestjs/config\");","const __WEBPACK_NAMESPACE_OBJECT__ = require(\"@prisma/client\");","import { Injectable, OnModuleInit, OnModuleDestroy, Logger } from '@nestjs/common';\r\nimport { PrismaClient } from '@prisma/client';\r\n\r\n@Injectable()\r\nexport class PrismaService extends PrismaClient implements OnModuleInit, OnModuleDestroy {\r\n  private readonly logger = new Logger(PrismaService.name);\r\n\r\n  constructor() {\r\n    super({\r\n      log: process.env.NODE_ENV === 'development' \r\n        ? ['query', 'info', 'warn', 'error'] \r\n        : ['error'],\r\n    });\r\n  }\r\n\r\n  async onModuleInit() {\r\n    try {\r\n      await this.$connect();\r\n      this.logger.log('Connected to PostgreSQL database');\r\n    } catch (error) {\r\n      this.logger.error('Failed to connect to PostgreSQL database', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  async onModuleDestroy() {\r\n    await this.$disconnect();\r\n    this.logger.log('Disconnected from PostgreSQL database');\r\n  }\r\n\r\n  /**\r\n   * Execute operations within a transaction\r\n   * All operations succeed or all fail together\r\n   */\r\n  async executeTransaction<T>(\r\n    fn: (tx: Omit<PrismaClient, '$connect' | '$disconnect' | '$on' | '$transaction' | '$use'>) => Promise<T>,\r\n  ): Promise<T> {\r\n    return this.$transaction(fn);\r\n  }\r\n\r\n  /**\r\n   * Clean database for testing purposes\r\n   * WARNING: This deletes all data!\r\n   */\r\n  async cleanDatabase() {\r\n    if (process.env.NODE_ENV !== 'test') {\r\n      throw new Error('cleanDatabase can only be used in test environment');\r\n    }\r\n    \r\n    const tablenames = await this.$queryRaw<Array<{ tablename: string }>>`\r\n      SELECT tablename FROM pg_tables WHERE schemaname='public'\r\n    `;\r\n\r\n    for (const { tablename } of tablenames) {\r\n      if (tablename !== '_prisma_migrations') {\r\n        await this.$executeRawUnsafe(`TRUNCATE TABLE \"public\".\"${tablename}\" CASCADE;`);\r\n      }\r\n    }\r\n  }\r\n}\r\n","import { Global, Module } from '@nestjs/common';\r\nimport { PrismaService } from './prisma.service';\r\n\r\n@Global()\r\n@Module({\r\n  providers: [PrismaService],\r\n  exports: [PrismaService],\r\n})\r\nexport class PrismaModule {}\r\n","import { Injectable } from '@nestjs/common';\r\nimport { PrismaService } from '@going-monorepo-clean/prisma-client';\r\n\r\n@Injectable()\r\nexport class PrismaPaymentRepository {\r\n  constructor(private readonly prisma: PrismaService) {}\r\n\r\n  // Payment CRUD\r\n  async createPayment(data: {\r\n    userId: string;\r\n    bookingId?: string;\r\n    parcelId?: string;\r\n    amount: number;\r\n    currency?: string;\r\n    method: 'CREDIT_CARD' | 'DEBIT_CARD' | 'BANK_TRANSFER' | 'WALLET' | 'CASH';\r\n  }) {\r\n    return this.prisma.payment.create({\r\n      data: {\r\n        ...data,\r\n        currency: data.currency || 'USD',\r\n        status: 'PENDING',\r\n      },\r\n    });\r\n  }\r\n\r\n  async findPaymentById(id: string) {\r\n    return this.prisma.payment.findUnique({\r\n      where: { id },\r\n      include: { user: true, booking: true, parcel: true },\r\n    });\r\n  }\r\n\r\n  async findPaymentsByUser(userId: string) {\r\n    return this.prisma.payment.findMany({\r\n      where: { userId },\r\n      include: { booking: true, parcel: true },\r\n      orderBy: { createdAt: 'desc' },\r\n    });\r\n  }\r\n\r\n  async findPaymentByTransactionId(transactionId: string) {\r\n    return this.prisma.payment.findFirst({\r\n      where: { transactionId },\r\n    });\r\n  }\r\n\r\n  async updatePaymentStatus(\r\n    id: string, \r\n    status: 'PENDING' | 'PROCESSING' | 'COMPLETED' | 'FAILED' | 'REFUNDED',\r\n    transactionId?: string\r\n  ) {\r\n    return this.prisma.payment.update({\r\n      where: { id },\r\n      data: { \r\n        status,\r\n        transactionId,\r\n      },\r\n    });\r\n  }\r\n\r\n  async completePayment(id: string, transactionId: string) {\r\n    return this.prisma.payment.update({\r\n      where: { id },\r\n      data: {\r\n        status: 'COMPLETED',\r\n        transactionId,\r\n      },\r\n    });\r\n  }\r\n\r\n  async failPayment(id: string) {\r\n    return this.prisma.payment.update({\r\n      where: { id },\r\n      data: { status: 'FAILED' },\r\n    });\r\n  }\r\n\r\n  async refundPayment(id: string) {\r\n    return this.prisma.payment.update({\r\n      where: { id },\r\n      data: { status: 'REFUNDED' },\r\n    });\r\n  }\r\n\r\n  // Stats\r\n  async getTotalByUser(userId: string) {\r\n    const result = await this.prisma.payment.aggregate({\r\n      where: { userId, status: 'COMPLETED' },\r\n      _sum: { amount: true },\r\n    });\r\n    return result._sum.amount || 0;\r\n  }\r\n}\r\n","const __WEBPACK_NAMESPACE_OBJECT__ = require(\"stripe\");","import { Injectable, Logger } from '@nestjs/common';\r\nimport { ConfigService } from '@nestjs/config';\r\nimport Stripe from 'stripe';\r\n\r\nexport interface PaymentIntentResult {\r\n  clientSecret: string;\r\n  paymentIntentId: string;\r\n}\r\n\r\n@Injectable()\r\nexport class StripeGateway {\r\n  private stripe: Stripe | null = null;\r\n  private webhookSecret: string = '';\r\n  private readonly logger = new Logger(StripeGateway.name);\r\n\r\n  constructor(private readonly configService: ConfigService) {\r\n    const secretKey = this.configService.get('STRIPE_SECRET_KEY');\r\n    this.webhookSecret = this.configService.get('STRIPE_WEBHOOK_SECRET') || '';\r\n\r\n    if (secretKey) {\r\n      this.stripe = new Stripe(secretKey, { apiVersion: '2024-06-20' as any });\r\n    } else {\r\n      this.logger.warn('Stripe keys not configured - payment gateway disabled');\r\n    }\r\n  }\r\n\r\n  async createPaymentIntent(amount: number, currency: string = 'USD'): Promise<PaymentIntentResult> {\r\n    if (!this.stripe) {\r\n      throw new Error('Stripe not configured');\r\n    }\r\n\r\n    const intent = await this.stripe.paymentIntents.create({\r\n      amount: Math.round(amount * 100), // Stripe uses cents\r\n      currency: currency.toLowerCase(),\r\n    });\r\n\r\n    if (!intent.client_secret) {\r\n      throw new Error('Failed to create Stripe Payment Intent');\r\n    }\r\n\r\n    return {\r\n      clientSecret: intent.client_secret,\r\n      paymentIntentId: intent.id,\r\n    };\r\n  }\r\n\r\n  async constructWebhookEvent(payload: Buffer, signature: string): Promise<any> {\r\n    if (!this.stripe) {\r\n      throw new Error('Stripe not configured');\r\n    }\r\n\r\n    return this.stripe.webhooks.constructEvent(\r\n      payload,\r\n      signature,\r\n      this.webhookSecret,\r\n    );\r\n  }\r\n\r\n  async refund(paymentIntentId: string, amount?: number): Promise<string> {\r\n    if (!this.stripe) {\r\n      throw new Error('Stripe not configured');\r\n    }\r\n\r\n    const refund = await this.stripe.refunds.create({\r\n      payment_intent: paymentIntentId,\r\n      amount: amount ? Math.round(amount * 100) : undefined,\r\n    });\r\n\r\n    return refund.id;\r\n  }\r\n}","import { Module, Global } from '@nestjs/common';\r\nimport { ConfigModule } from '@nestjs/config';\r\n\r\n// Shared Prisma Module\r\nimport { PrismaModule, PrismaService } from '@going-monorepo-clean/prisma-client';\r\n\r\n// Simple repositories and gateways\r\nimport { PrismaPaymentRepository } from './repositories/prisma-payment.repository';\r\nimport { StripeGateway } from './gateways/stripe.gateway';\r\n\r\nexport const I_PAYMENT_REPOSITORY = Symbol('IPaymentRepository');\r\nexport const I_PAYMENT_GATEWAY = Symbol('IPaymentGateway');\r\n\r\n@Global()\r\n@Module({\r\n  imports: [\r\n    ConfigModule.forRoot({ isGlobal: true }),\r\n    PrismaModule,\r\n  ],\r\n  providers: [\r\n    PrismaPaymentRepository,\r\n    StripeGateway,\r\n    {\r\n      provide: I_PAYMENT_REPOSITORY,\r\n      useClass: PrismaPaymentRepository,\r\n    },\r\n    {\r\n      provide: I_PAYMENT_GATEWAY,\r\n      useClass: StripeGateway,\r\n    },\r\n  ],\r\n  exports: [\r\n    I_PAYMENT_REPOSITORY, \r\n    I_PAYMENT_GATEWAY,\r\n    PrismaPaymentRepository, \r\n    StripeGateway,\r\n    PrismaService,\r\n  ],\r\n})\r\nexport class InfrastructureModule {}","import { Controller, Post, Body, Get, Param, Logger } from '@nestjs/common';\r\nimport { PrismaPaymentRepository } from '../infrastructure/repositories/prisma-payment.repository';\r\nimport { StripeGateway } from '../infrastructure/gateways/stripe.gateway';\r\n\r\n@Controller('payments')\r\nexport class PaymentController {\r\n  private readonly logger = new Logger(PaymentController.name);\r\n\r\n  constructor(\r\n    private readonly paymentRepository: PrismaPaymentRepository,\r\n    private readonly stripeGateway: StripeGateway,\r\n  ) {}\r\n\r\n  @Post()\r\n  async createPayment(@Body() body: {\r\n    userId: string;\r\n    amount: number;\r\n    currency?: string;\r\n    bookingId?: string;\r\n    parcelId?: string;\r\n    method?: 'CREDIT_CARD' | 'DEBIT_CARD' | 'BANK_TRANSFER' | 'WALLET' | 'CASH';\r\n  }) {\r\n    // Create payment record\r\n    const payment = await this.paymentRepository.createPayment({\r\n      userId: body.userId,\r\n      amount: body.amount,\r\n      currency: body.currency || 'USD',\r\n      bookingId: body.bookingId,\r\n      parcelId: body.parcelId,\r\n      method: body.method || 'CREDIT_CARD',\r\n    });\r\n\r\n    // Create Stripe payment intent for card payments\r\n    if (body.method === 'CREDIT_CARD' || body.method === 'DEBIT_CARD') {\r\n      try {\r\n        const intent = await this.stripeGateway.createPaymentIntent(\r\n          body.amount,\r\n          body.currency || 'USD',\r\n        );\r\n\r\n        return {\r\n          paymentId: payment.id,\r\n          clientSecret: intent.clientSecret,\r\n          paymentIntentId: intent.paymentIntentId,\r\n        };\r\n      } catch (error) {\r\n        this.logger.warn(`Stripe not available: ${error.message}`);\r\n        return { paymentId: payment.id };\r\n      }\r\n    }\r\n\r\n    return { paymentId: payment.id };\r\n  }\r\n\r\n  @Get('user/:userId')\r\n  async getPaymentsByUser(@Param('userId') userId: string) {\r\n    return this.paymentRepository.findPaymentsByUser(userId);\r\n  }\r\n\r\n  @Get(':id')\r\n  async getPayment(@Param('id') id: string) {\r\n    return this.paymentRepository.findPaymentById(id);\r\n  }\r\n}","import { Controller, Post, Req, Headers, Logger, RawBodyRequest } from '@nestjs/common';\r\nimport { Request } from 'express';\r\nimport { StripeGateway } from '../infrastructure/gateways/stripe.gateway';\r\nimport { PrismaPaymentRepository } from '../infrastructure/repositories/prisma-payment.repository';\r\n\r\n@Controller('webhook')\r\nexport class WebhookController {\r\n  private readonly logger = new Logger(WebhookController.name);\r\n\r\n  constructor(\r\n    private readonly stripeGateway: StripeGateway,\r\n    private readonly paymentRepository: PrismaPaymentRepository,\r\n  ) {}\r\n\r\n  @Post('stripe')\r\n  async handleStripeWebhook(\r\n    @Req() req: RawBodyRequest<Request>,\r\n    @Headers('stripe-signature') signature: string,\r\n  ) {\r\n    try {\r\n      const event = await this.stripeGateway.constructWebhookEvent(\r\n        req.rawBody as Buffer,\r\n        signature,\r\n      );\r\n\r\n      switch (event.type) {\r\n        case 'payment_intent.succeeded':\r\n          const paymentIntent = event.data.object;\r\n          await this.paymentRepository.completePayment(\r\n            paymentIntent.metadata?.paymentId || paymentIntent.id,\r\n            paymentIntent.id,\r\n          );\r\n          this.logger.log(`Payment completed: ${paymentIntent.id}`);\r\n          break;\r\n\r\n        case 'payment_intent.payment_failed':\r\n          const failedIntent = event.data.object;\r\n          this.logger.warn(`Payment failed: ${failedIntent.id}`);\r\n          break;\r\n\r\n        default:\r\n          this.logger.log(`Unhandled event type: ${event.type}`);\r\n      }\r\n\r\n      return { received: true };\r\n    } catch (error) {\r\n      this.logger.error(`Webhook error: ${error.message}`);\r\n      throw error;\r\n    }\r\n  }\r\n}","import { Module } from '@nestjs/common';\r\nimport { ConfigModule } from '@nestjs/config';\r\nimport { InfrastructureModule } from './infrastructure/infrastructure.module';\r\nimport { PaymentController } from './api/payment.controller';\r\nimport { WebhookController } from './api/webhook.controller';\r\n\r\n@Module({\r\n  imports: [\r\n    ConfigModule.forRoot({ isGlobal: true }),\r\n    InfrastructureModule,\r\n  ],\r\n  controllers: [PaymentController, WebhookController],\r\n  providers: [],\r\n})\r\nexport class AppModule {}","import { NestFactory } from '@nestjs/core';\r\nimport { AppModule } from './app.module';\r\nimport { Logger, ValidationPipe } from '@nestjs/common';\r\n\r\nasync function bootstrap() {\r\n  const app = await NestFactory.create(AppModule, {\r\n    rawBody: true, // Â¡ESENCIAL PARA STRIPE!\r\n  });\r\n\r\n  const port = process.env.PORT || 3001;\r\n  app.useGlobalPipes(new ValidationPipe({ whitelist: true, transform: true }));\r\n\r\n  await app.listen(port);\r\n  Logger.log(\r\n    `ðŸš€ Payment-Service estÃ¡ corriendo en http://localhost:${port}`,\r\n    'Bootstrap',\r\n  );\r\n}\r\nbootstrap();"],"names":["__webpack_require__","module","getter","__esModule","d","a","exports","definition","key","o","Object","defineProperty","enumerable","get","obj","prop","prototype","hasOwnProperty","call","require","PrismaService","PrismaClient","constructor","super","log","process","env","NODE_ENV","logger","Logger","name","onModuleInit","this","$connect","error","onModuleDestroy","$disconnect","executeTransaction","fn","$transaction","cleanDatabase","Error","tablenames","$queryRaw","tablename","$executeRawUnsafe","Injectable","PrismaModule","Global","Module","providers","PrismaPaymentRepository","prisma","createPayment","data","payment","create","currency","status","findPaymentById","id","findUnique","where","include","user","booking","parcel","findPaymentsByUser","userId","findMany","orderBy","createdAt","findPaymentByTransactionId","transactionId","findFirst","updatePaymentStatus","update","completePayment","failPayment","refundPayment","getTotalByUser","aggregate","_sum","amount","StripeGateway","configService","stripe","webhookSecret","secretKey","apiVersion","warn","createPaymentIntent","intent","paymentIntents","Math","round","toLowerCase","client_secret","clientSecret","paymentIntentId","constructWebhookEvent","payload","signature","webhooks","constructEvent","refund","refunds","payment_intent","undefined","ConfigService","I_PAYMENT_REPOSITORY","Symbol","I_PAYMENT_GATEWAY","InfrastructureModule","imports","ConfigModule","forRoot","isGlobal","provide","useClass","PaymentController","paymentRepository","stripeGateway","body","bookingId","parcelId","method","paymentId","message","getPaymentsByUser","getPayment","Post","Body","Get","Param","Controller","WebhookController","handleStripeWebhook","req","event","rawBody","type","paymentIntent","object","metadata","failedIntent","received","Req","Headers","RawBodyRequest","AppModule","controllers","app","NestFactory","port","PORT","useGlobalPipes","ValidationPipe","whitelist","transform","listen","bootstrap"],"ignoreList":[],"sourceRoot":""}