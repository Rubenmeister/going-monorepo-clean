(()=>{"use strict";var e={n:t=>{var r=t&&t.__esModule?()=>t.default:()=>t;return e.d(r,{a:r}),r},d:(t,r)=>{for(var a in r)e.o(r,a)&&!e.o(t,a)&&Object.defineProperty(t,a,{enumerable:!0,get:r[a]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};const t=require("tslib"),r=require("@nestjs/core"),a=require("@nestjs/common"),n=require("@nestjs/config"),i=require("@prisma/client");var o;let s=o=class PrismaService extends i.PrismaClient{constructor(){super({log:"development"===process.env.NODE_ENV?["query","info","warn","error"]:["error"]}),this.logger=new a.Logger(o.name)}onModuleInit(){return(0,t.__awaiter)(this,void 0,void 0,function*(){try{yield this.$connect(),this.logger.log("Connected to PostgreSQL database")}catch(e){throw this.logger.error("Failed to connect to PostgreSQL database",e),e}})}onModuleDestroy(){return(0,t.__awaiter)(this,void 0,void 0,function*(){yield this.$disconnect(),this.logger.log("Disconnected from PostgreSQL database")})}executeTransaction(e){return(0,t.__awaiter)(this,void 0,void 0,function*(){return this.$transaction(e)})}cleanDatabase(){return(0,t.__awaiter)(this,void 0,void 0,function*(){if("test"!==process.env.NODE_ENV)throw new Error("cleanDatabase can only be used in test environment");const e=yield this.$queryRaw`
      SELECT tablename FROM pg_tables WHERE schemaname='public'
    `;for(const{tablename:t}of e)"_prisma_migrations"!==t&&(yield this.$executeRawUnsafe(`TRUNCATE TABLE "public"."${t}" CASCADE;`))})}};s=o=(0,t.__decorate)([(0,a.Injectable)(),(0,t.__metadata)("design:paramtypes",[])],s);let d=class PrismaModule{};var c;d=(0,t.__decorate)([(0,a.Global)(),(0,a.Module)({providers:[s],exports:[s]})],d);let u=class PrismaPaymentRepository{constructor(e){this.prisma=e}createPayment(e){return(0,t.__awaiter)(this,void 0,void 0,function*(){return this.prisma.payment.create({data:Object.assign(Object.assign({},e),{currency:e.currency||"USD",status:"PENDING"})})})}findPaymentById(e){return(0,t.__awaiter)(this,void 0,void 0,function*(){return this.prisma.payment.findUnique({where:{id:e},include:{user:!0,booking:!0,parcel:!0}})})}findPaymentsByUser(e){return(0,t.__awaiter)(this,void 0,void 0,function*(){return this.prisma.payment.findMany({where:{userId:e},include:{booking:!0,parcel:!0},orderBy:{createdAt:"desc"}})})}findPaymentByTransactionId(e){return(0,t.__awaiter)(this,void 0,void 0,function*(){return this.prisma.payment.findFirst({where:{transactionId:e}})})}updatePaymentStatus(e,r,a){return(0,t.__awaiter)(this,void 0,void 0,function*(){return this.prisma.payment.update({where:{id:e},data:{status:r,transactionId:a}})})}completePayment(e,r){return(0,t.__awaiter)(this,void 0,void 0,function*(){return this.prisma.payment.update({where:{id:e},data:{status:"COMPLETED",transactionId:r}})})}failPayment(e){return(0,t.__awaiter)(this,void 0,void 0,function*(){return this.prisma.payment.update({where:{id:e},data:{status:"FAILED"}})})}refundPayment(e){return(0,t.__awaiter)(this,void 0,void 0,function*(){return this.prisma.payment.update({where:{id:e},data:{status:"REFUNDED"}})})}getTotalByUser(e){return(0,t.__awaiter)(this,void 0,void 0,function*(){return(yield this.prisma.payment.aggregate({where:{userId:e,status:"COMPLETED"},_sum:{amount:!0}}))._sum.amount||0})}};u=(0,t.__decorate)([(0,a.Injectable)(),(0,t.__metadata)("design:paramtypes",["function"==typeof(c=void 0!==s&&s)?c:Object])],u);const p=require("stripe");var y,m,l=e.n(p);let _=y=class StripeGateway{constructor(e){this.configService=e,this.stripe=null,this.webhookSecret="",this.logger=new a.Logger(y.name);const t=this.configService.get("STRIPE_SECRET_KEY");this.webhookSecret=this.configService.get("STRIPE_WEBHOOK_SECRET")||"",t?this.stripe=new(l())(t,{apiVersion:"2024-06-20"}):this.logger.warn("Stripe keys not configured - payment gateway disabled")}createPaymentIntent(e){return(0,t.__awaiter)(this,arguments,void 0,function*(e,t="USD"){if(!this.stripe)throw new Error("Stripe not configured");const r=yield this.stripe.paymentIntents.create({amount:Math.round(100*e),currency:t.toLowerCase()});if(!r.client_secret)throw new Error("Failed to create Stripe Payment Intent");return{clientSecret:r.client_secret,paymentIntentId:r.id}})}constructWebhookEvent(e,r){return(0,t.__awaiter)(this,void 0,void 0,function*(){if(!this.stripe)throw new Error("Stripe not configured");return this.stripe.webhooks.constructEvent(e,r,this.webhookSecret)})}refund(e,r){return(0,t.__awaiter)(this,void 0,void 0,function*(){if(!this.stripe)throw new Error("Stripe not configured");return(yield this.stripe.refunds.create({payment_intent:e,amount:r?Math.round(100*r):void 0})).id})}};_=y=(0,t.__decorate)([(0,a.Injectable)(),(0,t.__metadata)("design:paramtypes",["function"==typeof(m=void 0!==n.ConfigService&&n.ConfigService)?m:Object])],_);const h=Symbol("IPaymentRepository"),g=Symbol("IPaymentGateway");let v=class InfrastructureModule{};var f,w,b;v=(0,t.__decorate)([(0,a.Global)(),(0,a.Module)({imports:[n.ConfigModule.forRoot({isGlobal:!0}),d],providers:[u,_,{provide:h,useClass:u},{provide:g,useClass:_}],exports:[h,g,u,_,s]})],v);let P=f=class PaymentController{constructor(e,t){this.paymentRepository=e,this.stripeGateway=t,this.logger=new a.Logger(f.name)}createPayment(e){return(0,t.__awaiter)(this,void 0,void 0,function*(){const t=yield this.paymentRepository.createPayment({userId:e.userId,amount:e.amount,currency:e.currency||"USD",bookingId:e.bookingId,parcelId:e.parcelId,method:e.method||"CREDIT_CARD"});if("CREDIT_CARD"===e.method||"DEBIT_CARD"===e.method)try{const r=yield this.stripeGateway.createPaymentIntent(e.amount,e.currency||"USD");return{paymentId:t.id,clientSecret:r.clientSecret,paymentIntentId:r.paymentIntentId}}catch(r){return this.logger.warn(`Stripe not available: ${r.message}`),{paymentId:t.id}}return{paymentId:t.id}})}getPaymentsByUser(e){return(0,t.__awaiter)(this,void 0,void 0,function*(){return this.paymentRepository.findPaymentsByUser(e)})}getPayment(e){return(0,t.__awaiter)(this,void 0,void 0,function*(){return this.paymentRepository.findPaymentById(e)})}};var I,S,E,R;(0,t.__decorate)([(0,a.Post)(),(0,t.__param)(0,(0,a.Body)()),(0,t.__metadata)("design:type",Function),(0,t.__metadata)("design:paramtypes",[Object]),(0,t.__metadata)("design:returntype",Promise)],P.prototype,"createPayment",null),(0,t.__decorate)([(0,a.Get)("user/:userId"),(0,t.__param)(0,(0,a.Param)("userId")),(0,t.__metadata)("design:type",Function),(0,t.__metadata)("design:paramtypes",[String]),(0,t.__metadata)("design:returntype",Promise)],P.prototype,"getPaymentsByUser",null),(0,t.__decorate)([(0,a.Get)(":id"),(0,t.__param)(0,(0,a.Param)("id")),(0,t.__metadata)("design:type",Function),(0,t.__metadata)("design:paramtypes",[String]),(0,t.__metadata)("design:returntype",Promise)],P.prototype,"getPayment",null),P=f=(0,t.__decorate)([(0,a.Controller)("payments"),(0,t.__metadata)("design:paramtypes",["function"==typeof(w=void 0!==u&&u)?w:Object,"function"==typeof(b=void 0!==_&&_)?b:Object])],P);let C=I=class WebhookController{constructor(e,t){this.stripeGateway=e,this.paymentRepository=t,this.logger=new a.Logger(I.name)}handleStripeWebhook(e,r){return(0,t.__awaiter)(this,void 0,void 0,function*(){var t;try{const a=yield this.stripeGateway.constructWebhookEvent(e.rawBody,r);switch(a.type){case"payment_intent.succeeded":const e=a.data.object;yield this.paymentRepository.completePayment((null===(t=e.metadata)||void 0===t?void 0:t.paymentId)||e.id,e.id),this.logger.log(`Payment completed: ${e.id}`);break;case"payment_intent.payment_failed":const r=a.data.object;this.logger.warn(`Payment failed: ${r.id}`);break;default:this.logger.log(`Unhandled event type: ${a.type}`)}return{received:!0}}catch(a){throw this.logger.error(`Webhook error: ${a.message}`),a}})}};(0,t.__decorate)([(0,a.Post)("stripe"),(0,t.__param)(0,(0,a.Req)()),(0,t.__param)(1,(0,a.Headers)("stripe-signature")),(0,t.__metadata)("design:type",Function),(0,t.__metadata)("design:paramtypes",["function"==typeof(R=void 0!==a.RawBodyRequest&&a.RawBodyRequest)?R:Object,String]),(0,t.__metadata)("design:returntype",Promise)],C.prototype,"handleStripeWebhook",null),C=I=(0,t.__decorate)([(0,a.Controller)("webhook"),(0,t.__metadata)("design:paramtypes",["function"==typeof(S=void 0!==_&&_)?S:Object,"function"==typeof(E=void 0!==u&&u)?E:Object])],C);let D=class AppModule{};D=(0,t.__decorate)([(0,a.Module)({imports:[n.ConfigModule.forRoot({isGlobal:!0}),v],controllers:[P,C],providers:[]})],D),function(){(0,t.__awaiter)(this,void 0,void 0,function*(){const e=yield r.NestFactory.create(D,{rawBody:!0}),t=process.env.PORT||3001;e.useGlobalPipes(new a.ValidationPipe({whitelist:!0,transform:!0})),yield e.listen(t),a.Logger.log(`\ud83d\ude80 Payment-Service est\xe1 corriendo en http://localhost:${t}`,"Bootstrap")})}()})();
//# sourceMappingURL=main.js.map