(()=>{"use strict";var e={d:(t,r)=>{for(var i in r)e.o(r,i)&&!e.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:r[i]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{I_PARCEL_REPOSITORY:()=>v,Parcel:()=>Parcel});const r=require("tslib"),i=require("@nestjs/core"),o=require("@nestjs/common"),s=require("@nestjs/config"),a=require("@nestjs/mongoose"),n=require("@prisma/client");var d;let c=d=class PrismaService extends n.PrismaClient{constructor(){super({log:"development"===process.env.NODE_ENV?["query","info","warn","error"]:["error"]}),this.logger=new o.Logger(d.name)}onModuleInit(){return(0,r.__awaiter)(this,void 0,void 0,function*(){try{yield this.$connect(),this.logger.log("Connected to PostgreSQL database")}catch(e){throw this.logger.error("Failed to connect to PostgreSQL database",e),e}})}onModuleDestroy(){return(0,r.__awaiter)(this,void 0,void 0,function*(){yield this.$disconnect(),this.logger.log("Disconnected from PostgreSQL database")})}executeTransaction(e){return(0,r.__awaiter)(this,void 0,void 0,function*(){return this.$transaction(e)})}cleanDatabase(){return(0,r.__awaiter)(this,void 0,void 0,function*(){if("test"!==process.env.NODE_ENV)throw new Error("cleanDatabase can only be used in test environment");const e=yield this.$queryRaw`
      SELECT tablename FROM pg_tables WHERE schemaname='public'
    `;for(const{tablename:t}of e)"_prisma_migrations"!==t&&(yield this.$executeRawUnsafe(`TRUNCATE TABLE "public"."${t}" CASCADE;`))})}};c=d=(0,r.__decorate)([(0,o.Injectable)(),(0,r.__metadata)("design:paramtypes",[])],c);let u=class PrismaModule{};u=(0,r.__decorate)([(0,o.Global)(),(0,o.Module)({providers:[c],exports:[c]})],u);const l=require("uuid"),p=require("neverthrow"),y={generate:()=>(0,l.v4)(),isValid:e=>(0,l.validate)(e)};class Money{constructor(e){this.amount=e.amount,this.currency=e.currency}static create(e,t){const r=t.toUpperCase();return"USD"!==r?(0,p.err)(new Error("Invalid currency")):e<0?(0,p.err)(new Error("Amount cannot be negative")):Number.isInteger(e)?(0,p.ok)(new Money({amount:e,currency:r})):(0,p.err)(new Error("Amount must be in cents (an integer)"))}isPositive(){return this.amount>0}toPrimitives(){return{amount:this.amount,currency:this.currency}}static fromPrimitives(e){return new Money(e)}}class Location{constructor(e){this.address=e.address,this.city=e.city,this.country=e.country,this.latitude=e.latitude,this.longitude=e.longitude}static create(e){return e.address&&0!==e.address.length?e.latitude<-90||e.latitude>90?(0,p.err)(new Error("Invalid latitude")):e.longitude<-180||e.longitude>180?(0,p.err)(new Error("Invalid longitude")):(0,p.ok)(new Location(e)):(0,p.err)(new Error("Address is required"))}toPrimitives(){return Object.assign({},this)}static fromPrimitives(e){return new Location(e)}}const m=require("class-validator");class MoneyDto{}(0,r.__decorate)([(0,m.IsNotEmpty)(),(0,m.IsNumber)(),(0,m.Min)(0),(0,r.__metadata)("design:type",Number)],MoneyDto.prototype,"amount",void 0),(0,r.__decorate)([(0,m.IsNotEmpty)(),(0,m.IsIn)(["USD"]),(0,r.__metadata)("design:type",String)],MoneyDto.prototype,"currency",void 0);class LocationDto{}(0,r.__decorate)([(0,m.IsNotEmpty)(),(0,m.IsString)(),(0,r.__metadata)("design:type",String)],LocationDto.prototype,"address",void 0),(0,r.__decorate)([(0,m.IsNotEmpty)(),(0,m.IsString)(),(0,r.__metadata)("design:type",String)],LocationDto.prototype,"city",void 0),(0,r.__decorate)([(0,m.IsNotEmpty)(),(0,m.IsString)(),(0,r.__metadata)("design:type",String)],LocationDto.prototype,"country",void 0),(0,r.__decorate)([(0,m.IsNotEmpty)(),(0,m.IsLatitude)(),(0,r.__metadata)("design:type",Number)],LocationDto.prototype,"latitude",void 0),(0,r.__decorate)([(0,m.IsNotEmpty)(),(0,m.IsLongitude)(),(0,r.__metadata)("design:type",Number)],LocationDto.prototype,"longitude",void 0);class Parcel{constructor(e){this.id=e.id,this.userId=e.userId,this.driverId=e.driverId,this.origin=e.origin,this.destination=e.destination,this.description=e.description,this.price=e.price,this.status=e.status,this.createdAt=e.createdAt}static create(e){if(e.description.length<3)return(0,p.err)(new Error("Description must be at least 3 characters"));if(!e.price.isPositive())return(0,p.err)(new Error("Price must be positive"));const t=new Parcel(Object.assign(Object.assign({id:(0,l.v4)()},e),{status:"pending",createdAt:new Date}));return(0,p.ok)(t)}toPrimitives(){return{id:this.id,userId:this.userId,driverId:this.driverId,origin:this.origin.toPrimitives(),destination:this.destination.toPrimitives(),price:this.price.toPrimitives(),status:this.status,createdAt:this.createdAt}}static fromPrimitives(e){return new Parcel(Object.assign(Object.assign({},e),{origin:Location.fromPrimitives(e.origin),destination:Location.fromPrimitives(e.destination),price:Money.fromPrimitives(e.price)}))}assignDriver(e){return"pending"!==this.status?(0,p.err)(new Error("Parcel is not pending assignment")):(this.driverId=e,this.status="pickup_assigned",(0,p.ok)(void 0))}markAsInTransit(){return"pickup_assigned"!==this.status?(0,p.err)(new Error("Parcel must be assigned to a driver first")):(this.status="in_transit",(0,p.ok)(void 0))}deliver(){return"in_transit"!==this.status?(0,p.err)(new Error("Parcel is not in transit")):(this.status="delivered",(0,p.ok)(void 0))}}const v=Symbol("IParcelRepository");var _;let g=class PrismaParcelRepository{constructor(e){this.prisma=e}save(e){return(0,r.__awaiter)(this,void 0,void 0,function*(){var t,r,i,o,s,a,n;try{const d=e.toPrimitives();return yield this.prisma.parcel.create({data:{id:d.id,senderId:d.userId,receiverId:d.userId,description:d.description||"Package",weight:(null===(t=d.price)||void 0===t?void 0:t.amount)||1,price:(null===(r=d.price)||void 0===r?void 0:r.amount)||0,currency:(null===(i=d.price)||void 0===i?void 0:i.currency)||"USD",originCity:(null===(o=d.origin)||void 0===o?void 0:o.city)||"",originAddress:(null===(s=d.origin)||void 0===s?void 0:s.address)||"",destCity:(null===(a=d.destination)||void 0===a?void 0:a.city)||"",destAddress:(null===(n=d.destination)||void 0===n?void 0:n.address)||"",status:d.status}}),(0,p.ok)(void 0)}catch(d){return(0,p.err)(new Error(`Failed to save parcel: ${d.message}`))}})}findById(e){return(0,r.__awaiter)(this,void 0,void 0,function*(){try{const t=yield this.prisma.parcel.findUnique({where:{id:e}});return t?(0,p.ok)(this.toDomain(t)):(0,p.ok)(null)}catch(t){return(0,p.err)(new Error(`Failed to find parcel: ${t.message}`))}})}findByUserId(e){return(0,r.__awaiter)(this,void 0,void 0,function*(){try{const t=yield this.prisma.parcel.findMany({where:{OR:[{senderId:e},{receiverId:e}]}});return(0,p.ok)(t.map(e=>this.toDomain(e)))}catch(t){return(0,p.err)(new Error(`Failed to find parcels by user: ${t.message}`))}})}findByDriverId(e){return(0,r.__awaiter)(this,void 0,void 0,function*(){try{const t=yield this.prisma.parcel.findMany({where:{driverId:e}});return(0,p.ok)(t.map(e=>this.toDomain(e)))}catch(t){return(0,p.err)(new Error(`Failed to find parcels by driver: ${t.message}`))}})}update(e){return(0,r.__awaiter)(this,void 0,void 0,function*(){try{const t=e.toPrimitives();return yield this.prisma.parcel.update({where:{id:t.id},data:{status:t.status,driverId:t.driverId||null,updatedAt:new Date}}),(0,p.ok)(void 0)}catch(t){return(0,p.err)(new Error(`Failed to update parcel: ${t.message}`))}})}toDomain(e){return Parcel.fromPrimitives({id:e.id,userId:e.senderId,driverId:e.driverId,origin:{city:e.originCity,country:"EC",address:e.originAddress},destination:{city:e.destCity,country:"EC",address:e.destAddress},price:{amount:Number(e.price),currency:e.currency},status:e.status,createdAt:e.createdAt})}};g=(0,r.__decorate)([(0,o.Injectable)(),(0,r.__metadata)("design:paramtypes",["function"==typeof(_=void 0!==c&&c)?_:Object])],g);let h=class InfrastructureModule{};h=(0,r.__decorate)([(0,o.Global)(),(0,o.Module)({imports:[s.ConfigModule.forRoot({isGlobal:!0}),u],providers:[{provide:v,useClass:g}],exports:[v]})],h);const f=require("class-transformer");var I,P,w,E;class CreateParcelDto{}(0,r.__decorate)([(0,m.IsNotEmpty)(),(0,m.IsUUID)(),(0,r.__metadata)("design:type",String)],CreateParcelDto.prototype,"userId",void 0),(0,r.__decorate)([(0,m.IsNotEmpty)(),(0,m.ValidateNested)(),(0,f.Type)(()=>LocationDto),(0,r.__metadata)("design:type","function"==typeof(I=void 0!==LocationDto&&LocationDto)?I:Object)],CreateParcelDto.prototype,"origin",void 0),(0,r.__decorate)([(0,m.IsNotEmpty)(),(0,m.ValidateNested)(),(0,f.Type)(()=>LocationDto),(0,r.__metadata)("design:type","function"==typeof(P=void 0!==LocationDto&&LocationDto)?P:Object)],CreateParcelDto.prototype,"destination",void 0),(0,r.__decorate)([(0,m.IsNotEmpty)(),(0,m.IsString)(),(0,r.__metadata)("design:type",String)],CreateParcelDto.prototype,"description",void 0),(0,r.__decorate)([(0,m.IsNotEmpty)(),(0,m.ValidateNested)(),(0,f.Type)(()=>MoneyDto),(0,r.__metadata)("design:type","function"==typeof(w=void 0!==MoneyDto&&MoneyDto)?w:Object)],CreateParcelDto.prototype,"price",void 0);let b=class CreateParcelUseCase{constructor(e){this.parcelRepo=e}execute(e){return(0,r.__awaiter)(this,void 0,void 0,function*(){const t=Money.create(e.price.amount,e.price.currency);if(t.isErr())throw new o.InternalServerErrorException(t.error.message);const r=Location.create(e.origin),i=Location.create(e.destination);if(r.isErr())throw new o.InternalServerErrorException(r.error.message);if(i.isErr())throw new o.InternalServerErrorException(i.error.message);const s=Parcel.create({userId:e.userId,origin:r.value,destination:i.value,description:e.description,price:t.value});if(s.isErr())throw new o.InternalServerErrorException(s.error.message);const a=s.value,n=yield this.parcelRepo.save(a);if(n.isErr())throw new o.InternalServerErrorException(n.error.message);return{id:a.id}})}};b=(0,r.__decorate)([(0,o.Injectable)(),(0,r.__param)(0,(0,o.Inject)(v)),(0,r.__metadata)("design:paramtypes",["function"==typeof(E=void 0!==t.IParcelRepository&&t.IParcelRepository)?E:Object])],b);let D=class FindParcelsByUserUseCase{constructor(e){this.parcelRepo=e}execute(e){return(0,r.__awaiter)(this,void 0,void 0,function*(){const t=yield this.parcelRepo.findByUserId(e);if(t.isErr())throw new o.InternalServerErrorException(t.error.message);return t.value.map(e=>{const t=e.toPrimitives();return{id:t.id,status:t.status,description:t.description,originAddress:t.origin.address,destinationAddress:t.destination.address,price:t.price.amount,currency:t.price.currency,createdAt:t.createdAt}})})}};var C,S,j,L,M,O;D=(0,r.__decorate)([(0,o.Injectable)(),(0,r.__param)(0,(0,o.Inject)(v)),(0,r.__metadata)("design:paramtypes",[Object])],D);let A=class ParcelController{constructor(e,t){this.createParcelUseCase=e,this.findParcelsByUserUseCase=t}createParcel(e){return(0,r.__awaiter)(this,void 0,void 0,function*(){return this.createParcelUseCase.execute(e)})}getParcelsByUser(e){return(0,r.__awaiter)(this,void 0,void 0,function*(){return this.findParcelsByUserUseCase.execute(e)})}};(0,r.__decorate)([(0,o.Post)(),(0,r.__param)(0,(0,o.Body)()),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",["function"==typeof(j=void 0!==CreateParcelDto&&CreateParcelDto)?j:Object]),(0,r.__metadata)("design:returntype","function"==typeof(L="undefined"!=typeof Promise&&Promise)?L:Object)],A.prototype,"createParcel",null),(0,r.__decorate)([(0,o.Get)("user/:userId"),(0,r.__param)(0,(0,o.Param)("userId")),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",["function"==typeof(M=y)?M:Object]),(0,r.__metadata)("design:returntype","function"==typeof(O="undefined"!=typeof Promise&&Promise)?O:Object)],A.prototype,"getParcelsByUser",null),A=(0,r.__decorate)([(0,o.Controller)("parcels"),(0,r.__metadata)("design:paramtypes",["function"==typeof(C=void 0!==b&&b)?C:Object,"function"==typeof(S=void 0!==D&&D)?S:Object])],A);let N=class AppModule{};N=(0,r.__decorate)([(0,o.Module)({imports:[s.ConfigModule.forRoot({isGlobal:!0}),a.MongooseModule.forRoot(process.env.PARCEL_DB_URL),h],controllers:[A],providers:[b,D]})],N),function(){(0,r.__awaiter)(this,void 0,void 0,function*(){const e=yield i.NestFactory.create(N),t=process.env.PORT||3007;e.useGlobalPipes(new o.ValidationPipe({whitelist:!0,transform:!0})),yield e.listen(t),o.Logger.log(`\ud83d\ude80 Envios-Service est\xe1 corriendo en http://localhost:${t}`,"Bootstrap")})}()})();
//# sourceMappingURL=main.js.map