(()=>{"use strict";const e=require("tslib"),t=require("@nestjs/core"),o=require("@nestjs/common"),r=require("@nestjs/config"),i=require("@prisma/client");var n;let s=n=class PrismaService extends i.PrismaClient{constructor(){super({log:"development"===process.env.NODE_ENV?["query","info","warn","error"]:["error"]}),this.logger=new o.Logger(n.name)}onModuleInit(){return(0,e.__awaiter)(this,void 0,void 0,function*(){try{yield this.$connect(),this.logger.log("Connected to PostgreSQL database")}catch(e){throw this.logger.error("Failed to connect to PostgreSQL database",e),e}})}onModuleDestroy(){return(0,e.__awaiter)(this,void 0,void 0,function*(){yield this.$disconnect(),this.logger.log("Disconnected from PostgreSQL database")})}executeTransaction(t){return(0,e.__awaiter)(this,void 0,void 0,function*(){return this.$transaction(t)})}cleanDatabase(){return(0,e.__awaiter)(this,void 0,void 0,function*(){if("test"!==process.env.NODE_ENV)throw new Error("cleanDatabase can only be used in test environment");const e=yield this.$queryRaw`
      SELECT tablename FROM pg_tables WHERE schemaname='public'
    `;for(const{tablename:t}of e)"_prisma_migrations"!==t&&(yield this.$executeRawUnsafe(`TRUNCATE TABLE "public"."${t}" CASCADE;`))})}};s=n=(0,e.__decorate)([(0,o.Injectable)(),(0,e.__metadata)("design:paramtypes",[])],s);let a=class PrismaModule{};var c;a=(0,e.__decorate)([(0,o.Global)(),(0,o.Module)({providers:[s],exports:[s]})],a);let d=class PrismaBookingRepository{constructor(e){this.prisma=e}createBooking(t){return(0,e.__awaiter)(this,void 0,void 0,function*(){return this.prisma.booking.create({data:Object.assign(Object.assign({},t),{currency:t.currency||"USD",status:"PENDING"})})})}findBookingById(t){return(0,e.__awaiter)(this,void 0,void 0,function*(){return this.prisma.booking.findUnique({where:{id:t},include:{user:!0,accommodation:!0,experience:!0,transport:!0,tour:!0,payment:!0}})})}findBookingsByUser(t){return(0,e.__awaiter)(this,void 0,void 0,function*(){return this.prisma.booking.findMany({where:{userId:t},include:{accommodation:!0,experience:!0,transport:!0,tour:!0,payment:!0},orderBy:{createdAt:"desc"}})})}updateBookingStatus(t,o){return(0,e.__awaiter)(this,void 0,void 0,function*(){return this.prisma.booking.update({where:{id:t},data:{status:o}})})}confirmBooking(t){return(0,e.__awaiter)(this,void 0,void 0,function*(){return this.updateBookingStatus(t,"CONFIRMED")})}cancelBooking(t){return(0,e.__awaiter)(this,void 0,void 0,function*(){return this.updateBookingStatus(t,"CANCELLED")})}};d=(0,e.__decorate)([(0,o.Injectable)(),(0,e.__metadata)("design:paramtypes",["function"==typeof(c=void 0!==s&&s)?c:Object])],d);const u=Symbol("IBookingRepository");let l=class InfrastructureModule{};l=(0,e.__decorate)([(0,o.Global)(),(0,o.Module)({imports:[r.ConfigModule.forRoot({isGlobal:!0}),a],providers:[d,{provide:u,useClass:d}],exports:[u,d,s]})],l);let p=class AppModule{};p=(0,e.__decorate)([(0,o.Module)({imports:[r.ConfigModule.forRoot({isGlobal:!0}),l],controllers:[],providers:[]})],p),function(){(0,e.__awaiter)(this,void 0,void 0,function*(){const e=yield t.NestFactory.create(p),r=process.env.PORT||3010;e.useGlobalPipes(new o.ValidationPipe({whitelist:!0,transform:!0})),yield e.listen(r),o.Logger.log(`\ud83d\ude80 Booking-Service est\xe1 corriendo en http://localhost:${r}`,"Bootstrap")})}()})();
//# sourceMappingURL=main.js.map