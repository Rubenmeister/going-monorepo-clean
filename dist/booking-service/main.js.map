{"version":3,"file":"main.js","mappings":"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","sources":["external commonjs \"tslib\"","external commonjs \"@nestjs/core\"","external commonjs \"@nestjs/common\"","external commonjs \"@nestjs/config\"","external commonjs \"@prisma/client\"","C:\\Users\\USER1\\going-monorepo-clean\\libs\\shared\\prisma-client\\src\\lib\\prisma.service.ts","C:\\Users\\USER1\\going-monorepo-clean\\libs\\shared\\prisma-client\\src\\lib\\prisma.module.ts","C:\\Users\\USER1\\going-monorepo-clean\\booking-service\\src\\infrastructure\\persistence\\prisma-booking.repository.ts","C:\\Users\\USER1\\going-monorepo-clean\\booking-service\\src\\infrastructure\\infrastructure.module.ts","C:\\Users\\USER1\\going-monorepo-clean\\booking-service\\src\\app.module.ts","C:\\Users\\USER1\\going-monorepo-clean\\booking-service\\src\\main.ts"],"sourcesContent":["const __WEBPACK_NAMESPACE_OBJECT__ = require(\"tslib\");","const __WEBPACK_NAMESPACE_OBJECT__ = require(\"@nestjs/core\");","const __WEBPACK_NAMESPACE_OBJECT__ = require(\"@nestjs/common\");","const __WEBPACK_NAMESPACE_OBJECT__ = require(\"@nestjs/config\");","const __WEBPACK_NAMESPACE_OBJECT__ = require(\"@prisma/client\");","import { Injectable, OnModuleInit, OnModuleDestroy, Logger } from '@nestjs/common';\r\nimport { PrismaClient } from '@prisma/client';\r\n\r\n@Injectable()\r\nexport class PrismaService extends PrismaClient implements OnModuleInit, OnModuleDestroy {\r\n  private readonly logger = new Logger(PrismaService.name);\r\n\r\n  constructor() {\r\n    super({\r\n      log: process.env.NODE_ENV === 'development' \r\n        ? ['query', 'info', 'warn', 'error'] \r\n        : ['error'],\r\n    });\r\n  }\r\n\r\n  async onModuleInit() {\r\n    try {\r\n      await this.$connect();\r\n      this.logger.log('Connected to PostgreSQL database');\r\n    } catch (error) {\r\n      this.logger.error('Failed to connect to PostgreSQL database', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  async onModuleDestroy() {\r\n    await this.$disconnect();\r\n    this.logger.log('Disconnected from PostgreSQL database');\r\n  }\r\n\r\n  /**\r\n   * Execute operations within a transaction\r\n   * All operations succeed or all fail together\r\n   */\r\n  async executeTransaction<T>(\r\n    fn: (tx: Omit<PrismaClient, '$connect' | '$disconnect' | '$on' | '$transaction' | '$use'>) => Promise<T>,\r\n  ): Promise<T> {\r\n    return this.$transaction(fn);\r\n  }\r\n\r\n  /**\r\n   * Clean database for testing purposes\r\n   * WARNING: This deletes all data!\r\n   */\r\n  async cleanDatabase() {\r\n    if (process.env.NODE_ENV !== 'test') {\r\n      throw new Error('cleanDatabase can only be used in test environment');\r\n    }\r\n    \r\n    const tablenames = await this.$queryRaw<Array<{ tablename: string }>>`\r\n      SELECT tablename FROM pg_tables WHERE schemaname='public'\r\n    `;\r\n\r\n    for (const { tablename } of tablenames) {\r\n      if (tablename !== '_prisma_migrations') {\r\n        await this.$executeRawUnsafe(`TRUNCATE TABLE \"public\".\"${tablename}\" CASCADE;`);\r\n      }\r\n    }\r\n  }\r\n}\r\n","import { Global, Module } from '@nestjs/common';\r\nimport { PrismaService } from './prisma.service';\r\n\r\n@Global()\r\n@Module({\r\n  providers: [PrismaService],\r\n  exports: [PrismaService],\r\n})\r\nexport class PrismaModule {}\r\n","import { Injectable } from '@nestjs/common';\r\nimport { PrismaService } from '@going-monorepo-clean/prisma-client';\r\n\r\n@Injectable()\r\nexport class PrismaBookingRepository {\r\n  constructor(private readonly prisma: PrismaService) {}\r\n\r\n  async createBooking(data: {\r\n    userId: string;\r\n    type: 'ACCOMMODATION' | 'EXPERIENCE' | 'TRANSPORT' | 'TOUR';\r\n    accommodationId?: string;\r\n    experienceId?: string;\r\n    transportId?: string;\r\n    tourId?: string;\r\n    startDate: Date;\r\n    endDate?: Date;\r\n    guests: number;\r\n    totalPrice: number;\r\n    currency?: string;\r\n  }) {\r\n    return this.prisma.booking.create({\r\n      data: {\r\n        ...data,\r\n        currency: data.currency || 'USD',\r\n        status: 'PENDING',\r\n      },\r\n    });\r\n  }\r\n\r\n  async findBookingById(id: string) {\r\n    return this.prisma.booking.findUnique({\r\n      where: { id },\r\n      include: { \r\n        user: true,\r\n        accommodation: true,\r\n        experience: true,\r\n        transport: true,\r\n        tour: true,\r\n        payment: true \r\n      },\r\n    });\r\n  }\r\n\r\n  async findBookingsByUser(userId: string) {\r\n    return this.prisma.booking.findMany({\r\n      where: { userId },\r\n      include: { \r\n        accommodation: true,\r\n        experience: true,\r\n        transport: true,\r\n        tour: true,\r\n        payment: true \r\n      },\r\n      orderBy: { createdAt: 'desc' },\r\n    });\r\n  }\r\n\r\n  async updateBookingStatus(\r\n    id: string, \r\n    status: 'PENDING' | 'CONFIRMED' | 'CANCELLED' | 'COMPLETED'\r\n  ) {\r\n    return this.prisma.booking.update({\r\n      where: { id },\r\n      data: { status },\r\n    });\r\n  }\r\n\r\n  async confirmBooking(id: string) {\r\n    return this.updateBookingStatus(id, 'CONFIRMED');\r\n  }\r\n\r\n  async cancelBooking(id: string) {\r\n    return this.updateBookingStatus(id, 'CANCELLED');\r\n  }\r\n}\r\n","import { Module, Global } from '@nestjs/common';\r\nimport { ConfigModule } from '@nestjs/config';\r\n\r\n// Shared Prisma Module\r\nimport { PrismaModule, PrismaService } from '@going-monorepo-clean/prisma-client';\r\n\r\n// Repository\r\nimport { PrismaBookingRepository } from './persistence/prisma-booking.repository';\r\n\r\nexport const I_BOOKING_REPOSITORY = Symbol('IBookingRepository');\r\n\r\n@Global()\r\n@Module({\r\n  imports: [\r\n    ConfigModule.forRoot({ isGlobal: true }),\r\n    PrismaModule,\r\n  ],\r\n  providers: [\r\n    PrismaBookingRepository,\r\n    {\r\n      provide: I_BOOKING_REPOSITORY,\r\n      useClass: PrismaBookingRepository,\r\n    },\r\n  ],\r\n  exports: [I_BOOKING_REPOSITORY, PrismaBookingRepository, PrismaService],\r\n})\r\nexport class InfrastructureModule {}","import { Module } from '@nestjs/common';\r\nimport { ConfigModule } from '@nestjs/config';\r\nimport { InfrastructureModule } from './infrastructure/infrastructure.module';\r\n\r\n@Module({\r\n  imports: [\r\n    ConfigModule.forRoot({ isGlobal: true }),\r\n    InfrastructureModule,\r\n  ],\r\n  controllers: [],\r\n  providers: [],\r\n})\r\nexport class AppModule {}","import { NestFactory } from '@nestjs/core';\r\nimport { AppModule } from './app.module';\r\nimport { Logger, ValidationPipe } from '@nestjs/common';\r\n\r\nasync function bootstrap() {\r\n  const app = await NestFactory.create(AppModule);\r\n\r\n  const port = process.env.PORT || 3010; // Puerto para este microservicio\r\n\r\n  // Habilita la validaciÃ³n global de DTOs\r\n  app.useGlobalPipes(new ValidationPipe({ whitelist: true, transform: true }));\r\n\r\n  await app.listen(port);\r\n  Logger.log(\r\n    `ðŸš€ Booking-Service estÃ¡ corriendo en http://localhost:${port}`,\r\n    'Bootstrap',\r\n  );\r\n}\r\nbootstrap();"],"names":["require","PrismaService","PrismaClient","constructor","super","log","process","env","NODE_ENV","logger","Logger","name","onModuleInit","this","$connect","error","onModuleDestroy","$disconnect","executeTransaction","fn","$transaction","cleanDatabase","Error","tablenames","$queryRaw","tablename","$executeRawUnsafe","Injectable","PrismaModule","Global","Module","providers","exports","PrismaBookingRepository","prisma","createBooking","data","booking","create","currency","status","findBookingById","id","findUnique","where","include","user","accommodation","experience","transport","tour","payment","findBookingsByUser","userId","findMany","orderBy","createdAt","updateBookingStatus","update","confirmBooking","cancelBooking","I_BOOKING_REPOSITORY","Symbol","InfrastructureModule","imports","ConfigModule","forRoot","isGlobal","provide","useClass","AppModule","controllers","app","NestFactory","port","PORT","useGlobalPipes","ValidationPipe","whitelist","transform","listen","bootstrap"],"ignoreList":[],"sourceRoot":""}