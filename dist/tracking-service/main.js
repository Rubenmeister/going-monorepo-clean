(()=>{"use strict";const e=require("tslib"),t=require("@nestjs/core"),r=require("@nestjs/common"),o=require("@nestjs/config"),i=require("@prisma/client");var s;let a=s=class PrismaService extends i.PrismaClient{constructor(){super({log:"development"===process.env.NODE_ENV?["query","info","warn","error"]:["error"]}),this.logger=new r.Logger(s.name)}onModuleInit(){return(0,e.__awaiter)(this,void 0,void 0,function*(){try{yield this.$connect(),this.logger.log("Connected to PostgreSQL database")}catch(e){throw this.logger.error("Failed to connect to PostgreSQL database",e),e}})}onModuleDestroy(){return(0,e.__awaiter)(this,void 0,void 0,function*(){yield this.$disconnect(),this.logger.log("Disconnected from PostgreSQL database")})}executeTransaction(t){return(0,e.__awaiter)(this,void 0,void 0,function*(){return this.$transaction(t)})}cleanDatabase(){return(0,e.__awaiter)(this,void 0,void 0,function*(){if("test"!==process.env.NODE_ENV)throw new Error("cleanDatabase can only be used in test environment");const e=yield this.$queryRaw`
      SELECT tablename FROM pg_tables WHERE schemaname='public'
    `;for(const{tablename:t}of e)"_prisma_migrations"!==t&&(yield this.$executeRawUnsafe(`TRUNCATE TABLE "public"."${t}" CASCADE;`))})}};a=s=(0,e.__decorate)([(0,r.Injectable)(),(0,e.__metadata)("design:paramtypes",[])],a);let n=class PrismaModule{};var c;n=(0,e.__decorate)([(0,r.Global)(),(0,r.Module)({providers:[a],exports:[a]})],n);let l=class PrismaTrackingRepository{constructor(e){this.prisma=e}createTrackingEvent(t){return(0,e.__awaiter)(this,void 0,void 0,function*(){return this.prisma.trackingEvent.create({data:Object.assign(Object.assign({},t),{timestamp:new Date})})})}findEventsByParcel(t){return(0,e.__awaiter)(this,void 0,void 0,function*(){return this.prisma.trackingEvent.findMany({where:{parcelId:t},orderBy:{timestamp:"desc"}})})}getLatestEvent(t){return(0,e.__awaiter)(this,void 0,void 0,function*(){return this.prisma.trackingEvent.findFirst({where:{parcelId:t},orderBy:{timestamp:"desc"}})})}};l=(0,e.__decorate)([(0,r.Injectable)(),(0,e.__metadata)("design:paramtypes",["function"==typeof(c=void 0!==a&&a)?c:Object])],l);const d=Symbol("ITrackingRepository");let u=class InfrastructureModule{};u=(0,e.__decorate)([(0,r.Global)(),(0,r.Module)({imports:[o.ConfigModule.forRoot({isGlobal:!0}),n],providers:[l,{provide:d,useClass:l}],exports:[d,l,a]})],u);let p=class AppModule{};p=(0,e.__decorate)([(0,r.Module)({imports:[o.ConfigModule.forRoot({isGlobal:!0}),u],controllers:[],providers:[]})],p),function(){(0,e.__awaiter)(this,void 0,void 0,function*(){const e=yield t.NestFactory.create(p),o=process.env.PORT||3008;e.useGlobalPipes(new r.ValidationPipe({whitelist:!0,transform:!0})),yield e.listen(o),r.Logger.log(`\ud83d\ude80 Tracking-Service (HTTP y WebSocket) est\xe1 corriendo en http://localhost:${o}`,"Bootstrap")})}()})();
//# sourceMappingURL=main.js.map